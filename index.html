<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DepCom | Streaming Network</title>
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #e50914; --bg: #141414; --text: #fff; }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { background: var(--bg); color: var(--text); font-family: 'Montserrat', sans-serif; padding-bottom:50px; }

        /* --- Header & Nav --- */
        header { padding: 15px 5%; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.8); position: sticky; top: 0; z-index: 50; }
        .logo { font-weight: 900; font-size: 1.5rem; color: var(--primary); letter-spacing: 2px; }
        
        /* --- Grid --- */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; padding: 20px 5%; }
        .card { position: relative; height: 240px; border-radius: 8px; overflow: hidden; cursor: pointer; transition: 0.3s; background: #222; }
        .card:hover { transform: scale(1.05); z-index: 10; }
        .card img { width: 100%; height: 100%; object-fit: cover; }
        .card-info { position: absolute; bottom: 0; left: 0; width: 100%; padding: 10px; background: linear-gradient(transparent, black); }
        
        /* --- Admin Modal --- */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 100; display: none; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .box { background: #1f1f1f; width: 90%; max-width: 450px; padding: 30px; border-radius: 10px; }
        
        input, textarea, select { width: 100%; background: #333; border: 1px solid #444; color: white; padding: 12px; margin-bottom: 15px; border-radius: 4px; }
        button { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; border-radius: 4px; }
        button.cancel { background: #666; margin-top: 10px; }

        /* --- Player --- */
        .player-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 200; display: none; flex-direction: column; }
        .player-overlay.active { display: flex; }
        .video-container { flex: 1; display: flex; align-items: center; justify-content: center; }
        iframe { width: 100%; height: 100%; border: none; }
        .close-player { position: absolute; top: 20px; right: 20px; color: white; font-size: 30px; cursor: pointer; z-index: 210; background: rgba(0,0,0,0.5); padding: 5px; border-radius: 50%; }

        /* Estado de subida */
        .upload-status { font-size: 0.8rem; text-align: center; color: #aaa; margin-bottom: 10px; display: none; }
    </style>
</head>
<body>

    <header>
        <i class="material-icons" style="cursor:pointer;" onclick="toggleMenu()">menu</i>
        <div class="logo">DEPCOM</div>
        <i class="material-icons" style="cursor:pointer;" onclick="openAdmin()">settings</i>
    </header>

    <!-- MENÚ LATERAL -->
    <div id="sideMenu" style="position:fixed; top:0; left:0; height:100%; width:250px; background:#111; transform:translateX(-100%); transition:0.3s; z-index:60; padding-top:60px; border-right:1px solid #333;">
        <i class="material-icons" onclick="toggleMenu()" style="position:absolute; top:20px; right:20px; color:white; cursor:pointer;">close</i>
        <ul style="list-style:none; padding:20px;">
            <li style="margin-bottom:20px;"><a href="#" onclick="filter('all'); toggleMenu()" style="color:white; text-decoration:none;">Inicio</a></li>
            <li style="margin-bottom:20px;"><a href="#" onclick="filter('Peliculas'); toggleMenu()" style="color:white; text-decoration:none;">Películas</a></li>
            <li style="margin-bottom:20px;"><a href="#" onclick="filter('Series'); toggleMenu()" style="color:white; text-decoration:none;">Series</a></li>
        </ul>
    </div>

    <!-- GRID CONTENIDO -->
    <h2 style="padding: 20px 5%;">Catálogo</h2>
    <div class="grid" id="grid"></div>

    <!-- ADMIN MODAL -->
    <div class="modal" id="adminModal">
        <div class="box">
            <h2 style="margin-bottom:20px; color:var(--primary);">Subir Contenido</h2>
            
            <div id="authView">
                <input type="email" id="email" placeholder="Email Admin">
                <input type="password" id="pass" placeholder="Contraseña">
                <button onclick="login()">ENTRAR</button>
            </div>

            <div id="uploadView" style="display:none;">
                <input type="text" id="title" placeholder="Título">
                <textarea id="desc" rows="2" placeholder="Descripción..."></textarea>
                
                <select id="category">
                    <option value="Peliculas">Película</option>
                    <option value="Series">Serie</option>
                    <option value="Documentales">Documental</option>
                </select>

                <!-- IMAGEN: SUBIDA AUTOMÁTICA -->
                <label style="font-size:0.8rem; color:#ccc;">Portada (Se subirá a ImgBB)</label>
                <input type="file" id="fileThumb" accept="image/*">
                
                <!-- VIDEO: LINK YOUTUBE -->
                <label style="font-size:0.8rem; color:#ccc;">Video (Link de YouTube)</label>
                <input type="text" id="ytLink" placeholder="Ej: https://youtu.be/...">

                <p class="upload-status" id="statusMsg">Subiendo imagen...</p>
                
                <button onclick="uploadContent()">PUBLICAR</button>
                <button class="cancel" onclick="closeAdmin()">Cerrar</button>
                <button onclick="logout()" style="background:none; color:red; margin-top:10px;">Salir</button>
            </div>
        </div>
    </div>

    <!-- REPRODUCTOR -->
    <div class="player-overlay" id="player">
        <i class="material-icons close-player" onclick="closePlayer()">close</i>
        <div class="video-container" id="videoContainer"></div>
        <div style="padding:20px; background:#111;">
            <h2 id="pTitle"></h2>
            <p id="pDesc" style="color:#999; margin-top:10px;"></p>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, orderBy, query, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- CONFIGURACIÓN ---
        // 1. Pon TU Configuración de Firebase aquí:
        const firebaseConfig = {
            apiKey: "AIzaSyCIB1ZTy62DOmez1RKm8-bGOf9Lb8gA0cA",
            authDomain: "depcom-videos.firebaseapp.com",
            projectId: "depcom-videos",
            storageBucket: "depcom-videos.firebasestorage.app",
            messagingSenderId: "305553483794",
            appId: "1:305553483794:web:d012684a8631bd453b50cb"
        };
        
        // 2. Pon TU API KEY de ImgBB aquí (Consíguela en api.imgbb.com):
        const IMGBB_API_KEY = "39ee0c747116db6325c3229acf445d32"; 

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- FUNCIONES UI ---
        window.toggleMenu = () => document.getElementById('sideMenu').style.transform = 
            document.getElementById('sideMenu').style.transform === 'translateX(0px)' ? 'translateX(-100%)' : 'translateX(0px)';
        
        window.openAdmin = () => document.getElementById('adminModal').classList.add('active');
        window.closeAdmin = () => document.getElementById('adminModal').classList.remove('active');

        // --- LECTURA DATOS ---
        let allData = [];
        const q = query(collection(db, "videos"), orderBy("date", "desc"));
        onSnapshot(q, (snap) => {
            allData = [];
            document.getElementById('grid').innerHTML = '';
            snap.forEach(d => {
                const vid = {id: d.id, ...d.data()};
                allData.push(vid);
                renderCard(vid);
            });
        });

        function renderCard(vid) {
            const div = document.createElement('div');
            div.className = 'card';
            div.onclick = () => playVideo(vid);
            
            // Botón borrar para admin
            const del = auth.currentUser ? `<button onclick="event.stopPropagation(); deleteVid('${vid.id}')" style="position:absolute; top:5px; right:5px; width:30px; padding:5px; background:red;">X</button>` : '';

            div.innerHTML = `
                <img src="${vid.thumb}" onerror="this.src='https://via.placeholder.com/300'">
                ${del}
                <div class="card-info">
                    <h4>${vid.title}</h4>
                    <span style="font-size:0.7rem; color:#aaa;">${vid.category}</span>
                </div>
            `;
            document.getElementById('grid').appendChild(div);
        }

        window.filter = (cat) => {
            document.getElementById('grid').innerHTML = '';
            const list = cat === 'all' ? allData : allData.filter(x => x.category === cat);
            list.forEach(renderCard);
        };

        // --- SUBIDA (IMGBB + FIREBASE) ---
        window.uploadContent = async () => {
            const title = document.getElementById('title').value;
            const desc = document.getElementById('desc').value;
            const cat = document.getElementById('category').value;
            const file = document.getElementById('fileThumb').files[0];
            const link = document.getElementById('ytLink').value;
            const status = document.getElementById('statusMsg');

            if(!title || !file || !link) return alert("Faltan datos (Título, Imagen o Link)");

            status.style.display = 'block';
            status.innerText = "Subiendo imagen a ImgBB...";

            try {
                // 1. Subir Imagen a ImgBB (API Externa Gratuita)
                const formData = new FormData();
                formData.append("image", file);
                
                const imgRes = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                    method: 'POST',
                    body: formData
                });
                const imgData = await imgRes.json();
                
                if(!imgData.success) throw new Error("Fallo al subir imagen");
                const thumbUrl = imgData.data.url;

                // 2. Extraer ID de YouTube
                let videoId = "";
                const match = link.match(/^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/);
                if (match && match[2].length == 11) videoId = match[2];
                else throw new Error("Link de YouTube inválido");

                // 3. Guardar en Firebase
                status.innerText = "Guardando en base de datos...";
                await addDoc(collection(db, "videos"), {
                    title: title,
                    description: desc,
                    category: cat,
                    thumb: thumbUrl, // URL que nos dio ImgBB
                    src: videoId,    // ID de YouTube
                    type: 'youtube',
                    date: Date.now()
                });

                status.style.display = 'none';
                alert("¡Publicado!");
                window.closeAdmin();
                
                // Limpiar
                document.getElementById('title').value = '';
                document.getElementById('ytLink').value = '';
                document.getElementById('fileThumb').value = '';

            } catch(e) {
                console.error(e);
                status.innerText = "Error: " + e.message;
                alert("Error: " + e.message);
            }
        };

        window.deleteVid = async (id) => {
            if(confirm("¿Borrar?")) await deleteDoc(doc(db, "videos", id));
        };

        // --- AUTH ---
        window.login = async () => {
            try { await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('pass').value); }
            catch(e) { alert("Error login"); }
        };
        window.logout = () => signOut(auth);

        onAuthStateChanged(auth, (user) => {
            document.getElementById('authView').style.display = user ? 'none' : 'block';
            document.getElementById('uploadView').style.display = user ? 'block' : 'none';
        });

        // --- PLAYER ---
        window.playVideo = (vid) => {
            const overlay = document.getElementById('player');
            const container = document.getElementById('videoContainer');
            
            document.getElementById('pTitle').innerText = vid.title;
            document.getElementById('pDesc').innerText = vid.description;
            
            container.innerHTML = `<iframe src="https://www.youtube.com/embed/${vid.src}?autoplay=1&rel=0&modestbranding=1" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;
            
            overlay.classList.add('active');
        };

        window.closePlayer = () => {
            document.getElementById('player').classList.remove('active');
            document.getElementById('videoContainer').innerHTML = '';
        }
    </script>
</body>
</html>
